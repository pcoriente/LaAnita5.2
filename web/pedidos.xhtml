<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <h:outputStylesheet library="css" name="main.css"/>
        <h:outputStylesheet library="css" name="estilos.css"/>

        <title>Pedidos de clientes</title>
    </h:head>
    <body>
        <div id="wrapper" >
            <ui:include src="wrapper.xhtml" />
            <h:form id="main" onkeypress="return event.keyCode !== 13;" >
                <p:messages id="msgsPedidos" autoUpdate="false" showDetail="true" closable="true" />
                <p:panel id="panelPedidos" header="Mantenimiento de Pedidos" style="float: left;"
                         rendered="#{not empty mbPedidos.obtenerAcciones(31)}" >
                    <p:panelGrid id="pedidos" >
                        <f:facet name="header" >
                            <p:row >
                                <p:column >
                                    <h:outputLabel for="almacen" value="ALMACEN :" style="font-weight: bold; color: black;" />
                                </p:column>
                                <p:column >
                                    <p:selectOneMenu id="almacen" value="#{mbPedidos.mbAlmacenes.toAlmacen}" style="width: 350px;" >
                                        <f:converter converterId="converters.TOAlmacenJSConverter" />
                                        <f:selectItems value="#{mbPedidos.mbAlmacenes.listaAlmacenes}" />
                                        <p:ajax event="change" listener="#{mbPedidos.obtenerPedidos()}" 
                                                update=":main:msgsPedidos chkTodosLosPedios fechaInicial btnNuevoPedido listaDePedidos" />
                                    </p:selectOneMenu>
                                </p:column>
                                <p:column >
                                    <p:selectBooleanCheckbox id="chkTodosLosPedios" itemLabel="PENDIENTES" value="#{mbPedidos.pendientes}" 
                                                             disabled="#{mbPedidos.mbAlmacenes.toAlmacen.idAlmacen==0}" >
                                        <p:ajax listener="#{mbPedidos.obtenerPedidos()}" 
                                                update=":main:msgsPedidos fechaInicial listaDePedidos" />
                                    </p:selectBooleanCheckbox>
                                </p:column>
                                <p:column >
                                    <p:calendar id="fechaInicial" value="#{mbPedidos.fechaInicial}" 
                                                readonlyInput="true" disabled="#{mbPedidos.mbAlmacenes.toAlmacen.idAlmacen==0 || mbPedidos.pendientes}"
                                                locale="es" navigator="true" pattern="dd/MM/yyyy" >
                                        <p:ajax event="dateSelect" process="@this" listener="#{mbPedidos.obtenerPedidos()}" 
                                                update=":main:msgsPedidos listaDePedidos" />
                                    </p:calendar>
                                </p:column>
                                <p:column style="text-align: right;" >
                                    <p:commandButton id="btnNuevoPedido" icon="ui-icon-document" title="Nuevo Pedido" 
                                                     disabled="#{mbPedidos.mbAlmacenes.toAlmacen.idAlmacen==0}"
                                                     process="@this" actionListener="#{mbPedidos.nuevoPedido()}" 
                                                     update=":main:nuevoPedido" oncomplete="PF('nuevoPedidoDlg').show();" />
                                    <p:commandButton icon="ui-icon-home" title="Salir" immediate="true" 
                                                     ajax="false" action="#{mbPedidos.terminar()}" />
                                </p:column>
                            </p:row>
                        </f:facet>
                    </p:panelGrid>
                    <p:dataTable id="listaDePedidos" value="#{mbPedidos.pedidos}" 
                                 var="pedido" rowKey="#{pedido.idMovto}" selectionMode="single" 
                                 style="border:solid 1px; width: 910px;" emptyMessage="No existen pedidos" >
                        <p:ajax event="rowSelect" listener="#{mbPedidos.obtenerDetalle}" 
                                update=":main:msgsPedidos :main:pedido :main:detallePedido :main:totales" 
                                oncomplete="abrirPedido(xhr, status, args);" />

                        <p:column headerText="Tienda" >
                            <h:outputText value="#{pedido.tienda.tienda}" />
                        </p:column>
                        <p:column headerText="Pedido" style="width: 45px;" >
                            <h:outputText value="#{pedido.pedidoFolio}" />
                        </p:column>
                        <p:column headerText="Fecha" style="width: 110px;" >
                            <h:outputText value="#{pedido.pedidoFecha}" >
                                <f:convertDateTime pattern="dd/MM/yyyy hh:mm a" type="date" timeZone="#{mbPedidos.zonaHoraria.ID}" />
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Usuario" style="width: 45px;" >
                            <h:outputText value="#{pedido.pedidoIdUsuario}" />
                        </p:column>
                        <p:column headerText="Orden De Compra" style="width: 110px;" >
                            <h:outputText value="#{pedido.ordenDeCompra}" />
                        </p:column>
                        <p:column headerText="Estatus" style="width: 50px;" >
                            <h:outputText value="#{pedido.pedidoEstatus==0?'Pendiente':pedido.pedidoEstatus==1?'Solicitado':pedido.pedidoEstatus==2?'Rechazado':pedido.pedidoEstatus==3?'Aceptado':pedido.pedidoEstatus==5?'Ordenado':pedido.pedidoEstatus==6?'Cancelado':'Cerrado'}" />
                        </p:column>
                    </p:dataTable>
                </p:panel>
                <p:dialog header="CANCELAR PEDIDO" widgetVar="cancelarPedidoDlg" closable="true" resizable="false" style="width:600px;" modal="true" >
                    <p:panelGrid id="cancelarPedido" styleClass="sinBorde" >
                        <p:row >
                            <p:column >
                                <h:outputLabel for="motivo" value="MOTIVO :" style="font-weight: bold; color: red;" />
                            </p:column>
                            <p:column >
                                <p:inputTextarea id="motivo" rows="5" cols="50" 
                                                 value="#{mbPedidos.pedido.canceladoMotivo}" />
                            </p:column>
                        </p:row>
                        <f:facet name="footer" >
                            <p:row >
                                <p:column colspan="2" style="text-align: right;" >
                                    <p:commandButton id="btnCancelarPedido" icon="ui-icon-cancel" value="CANCELAR" title="Cancelar pedido" 
                                                     process="@this motivo" actionListener="#{mbPedidos.cancelarPedido()}" 
                                                     update=":main:msgsPedido :main:pedido :main:totales"
                                                     oncomplete="PF('cancelarPedidoDlg').hide()" />
                                </p:column>
                            </p:row>
                        </f:facet>
                    </p:panelGrid>
                </p:dialog>
                <p:dialog header="Similares" widgetVar="similaresDlg" closable="true" resizable="false" style="width: 600px;" modal="true" >
                    <p:messages id="msgsSimilares" showDetail="true" autoUpdate="true" closable="true" />
                    <p:panelGrid id="panelSimilares" styleClass="sinBorde" >
                        <p:row >
                            <p:column >
                                <h:outputLabel for="txtOriginalSinCargo" value="Sin Cargo :" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column >
                                <p:inputText id="txtOriginalSinCargo" value="#{mbPedidos.producto.ordenadaSinCargo}" size="14" readonly="true" >
                                    <f:convertNumber pattern="###,##0.0000" />
                                </p:inputText>
                            </p:column>
                            <p:column >
                                <h:outputLabel for="txtCantTraspasar" value="Traspasar :" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column >
                                <p:inputText id="txtCantTraspasar" value="#{mbPedidos.cantTraspasar}" style="width: 120px;" >
                                    <p:ajax event="change" process="@this" update=":main:detalleSimilares:btnSeleccion" />
                                </p:inputText>
                            </p:column>
                        </p:row>
                    </p:panelGrid>
                    <p:dataTable id="detalleSimilares" value="#{mbPedidos.similares}" 
                                 var="similar" scrollable="true" scrollHeight="200" style="width: 650px;"
                                 rowKey="#{similar.producto}" selectionMode="single" selection="#{mbPedidos.similar}" >
                        <p:ajax event = "rowSelect" update="btnSeleccion" />

                        <f:facet name="header">Seleccione un similar</f:facet>

                        <p:column headerText="SKU" style="width: 50px;" >
                            <h:outputText value="#{similar.producto.cod_pro}" />
                        </p:column>

                        <p:column headerText="Producto" style="width: 420px;" >
                            <h:outputText value="#{similar.producto.toString()}" />
                        </p:column>

                        <p:column headerText="Cajas" >
                            <h:outputText value="#{similar.ordenada}" >
                                <f:convertNumber pattern="##,###,##0.000" />
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Sin Cargo" >
                            <h:outputText value="#{similar.ordenadaSinCargo}" >
                                <f:convertNumber pattern="###,##0.000" />
                            </h:outputText>
                        </p:column>

                        <f:facet name="footer">
                            <p:commandButton id="btnSeleccion" value="Seleccionar" 
                                             disabled="#{mbPedidos.similar==null || mbPedidos.cantTraspasar==0}"
                                             process="@this" actionListener="#{mbPedidos.actualizaTraspasoSimilar()}"
                                             update=":main:msgsSimilares :main:detallePedido" 
                                             oncomplete="handleSimilares(xhr, status, args);" />
                        </f:facet>
                    </p:dataTable>
                </p:dialog>
                <p:dialog header="Edicion" widgetVar="EdicionDlg" closable="false" resizable="false" style="width: 600px;" modal="true" >
                    <p:ajax event="close" update=":main:detallePedido" />
                    <p:messages id="msgsEdicion" showDetail="true" closable="true" />
                    <p:panelGrid id="panelEdicion" styleClass="sinBorde" >
                        <p:row >
                            <p:column >
                                <h:outputLabel value="PRODUCTO :" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column colspan="4" >
                                <h:outputText value="#{mbPedidos.producto.toString()}" />
                            </p:column>
                        </p:row>
                        <p:row >
                            <p:column >
                                <h:outputLabel value="CAJAS :" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column >
                                <p:inputText value="#{mbPedidos.producto.ordenada}" style="width: 80px;"
                                             readonly="#{mbPedidos.pedido.pedidoEstatus!=0 or !mbPedidos.locked or mbPedidos.pedido.especial}"
                                             converterMessage="El valor proporcionado no es un numero" >
                                    <f:validateDoubleRange minimum="0.0" maximum="999999.999" />
                                    <p:ajax event="change" process="@this" listener="#{mbPedidos.actualizaProducto()}" 
                                            update="@this :main:msgsEdicion txtCantSinCargo btnSimilares :main:detallePedido :main:totales" />
                                </p:inputText>
                            </p:column>
                            <p:column >
                                <h:outputLabel value="SIN CARGO :" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column >
                                <p:inputText id="txtCantSinCargo" value="#{mbPedidos.producto.ordenadaSinCargo}" style="width: 80px;"
                                             readonly="#{mbPedidos.pedido.pedidoEstatus!=0 or !mbPedidos.locked or !mbPedidos.pedido.especial}"
                                             converterMessage="El valor proporcionado no es un numero" >
                                    <f:validateDoubleRange minimum="0.0" maximum="10000.0" />
                                    <p:ajax event="change" process="@this" listener="#{mbPedidos.actualizaProductoSinCargo()}" 
                                            update=":main:msgsEdicion :main:detallePedido" />
                                </p:inputText>
                            </p:column>
                            <p:column >
                                <p:commandButton id="btnSimilares" icon="ui-icon-transfer-e-w" title="Traspasar sin cargo a similar"
                                                 disabled="#{mbPedidos.pedido.pedidoEstatus!=0 or !mbPedidos.locked 
                                                             or mbPedidos.producto.ordenadaSinCargo==0 or mbPedidos.pedido.especial}"
                                                 process="@this" actionListener="#{mbPedidos.traspasoSimilar()}" 
                                                 update=":main:msgsPedido :main:panelSimilares :main:detalleSimilares"
                                                 oncomplete="handleAbrirSimilares(xhr, status, args);" />
                            </p:column>
                        </p:row>
                        <f:facet name="footer" >
                            <p:row >
                                <p:column >
                                    <p:commandButton icon="ui-icon-trash" title="Eliminar producto"
                                                     disabled="#{mbPedidos.pedido.pedidoEstatus!=0 or !mbPedidos.locked}"
                                                     process="@this" actionListener="#{mbPedidos.eliminarProducto()}"
                                                     update="msgsEdicion :main:msgsPedido :main:detallePedido :main:totales"
                                                     oncomplete="handleProductoEliminar(xhr, status, args);" />
                                </p:column>
                                <p:column colspan="4" style="text-align: right;" >
                                    <p:commandButton icon="ui-icon-arrowreturnthick-1-w" value="Salir" title="Fin de edicion" 
                                                     immediate="true" onclick="PF('EdicionDlg').hide();" />
                                </p:column>
                            </p:row>
                        </f:facet>
                    </p:panelGrid>
                </p:dialog>
                <p:dialog header="Captura de Pedido" widgetVar="pedidoDlg" resizable="false" modal="true" >
                    <p:ajax event="close" listener="#{mbPedidos.salir()}" update=":main:msgsPedidos :main:listaDePedidos" />
                    <p:messages id="msgsPedido" autoUpdate="false" showDetail="true" closable="true" />
                    <p:panelGrid id="pedido" style="width: 910px;" >
                        <p:row >
                            <p:column style="width: 80px;" >
                                <h:outputLabel for="txtFormato" value="CLIENTE:" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column colspan="4" style="width: 330px;" >
                                <p:inputText id="txtFormato" value="#{mbPedidos.pedido.tienda.contribuyente}" readonly="true" size="45" />
                            </p:column>
                            <p:column style="width: 90px;" >
                                <h:outputLabel for="txtTienda" value="TIENDA:" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column colspan="3" style="width: 400px;" >
                                <p:inputText id="txtTienda" value="#{mbPedidos.pedido.tienda.tienda}" readonly="true" size="50" />
                            </p:column>
                        </p:row>
                        <p:row >
                            <p:column colspan="2" style="width: 180px;" >
                                <h:outputLabel for="ordenDeCompra" value="ORDEN DE COMPRA:" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column colspan="3" style="width: 230px;" >
                                <p:inputText id="ordenDeCompra" value="#{mbPedidos.pedido.ordenDeCompra}" readonly="true" size="29" />
                            </p:column>
                            <p:column style="width: 90px;" >
                                <h:outputLabel for="ordenDeCompraFecha" value="FECHA:" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column style="width: 120px;" >
                                <p:inputText id="ordenDeCompraFecha" value="#{mbPedidos.pedido.ordenDeCompraFecha}" readonly="true" size="11" >
                                    <f:convertDateTime pattern="dd/MM/yyyy" type="date" timeZone="#{mbPedidos.zonaHoraria.ID}" />
                                </p:inputText>
                            </p:column>
                            <p:column style="width: 90px;" >
                                <h:outputLabel for="moneda" value="MONEDA:" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column style="width: 190px; text-align: right;" >
                                <p:inputText id="moneda" value="#{mbPedidos.pedido.comprobante.moneda.moneda}" readonly="true" size="22" />
                            </p:column>
                        </p:row>
                        <p:row >
                            <p:column style="width: 80px;" >
                                <h:outputLabel for="txtPedido" value="PEDIDO:" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column style="width: 70px;" >
                                <p:inputText id="txtPedido" value="#{mbPedidos.pedido.pedidoFolio}" readonly="true" size="6" />
                            </p:column>
                            <p:column style="width: 50px;" >
                                <h:outputLabel for="txtFecha" value="FECHA:" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column style="width: 70px;" >
                                <p:inputText id="txtFecha" value="#{mbPedidos.pedido.pedidoFecha}" readonly="true" size="11" style="width: 60px;" >
                                    <f:convertDateTime pattern="dd/MM/yyyy" type="date" timeZone="#{mbPedidos.zonaHoraria.ID}" />
                                </p:inputText>
                            </p:column>
                            <p:column colspan="2" >
                            </p:column>
                            <p:column style="text-align: right;" >
                                <h:outputLabel for="txtDesctoComercial" value="DESCUENTO :" style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column style="width: 90px;" >
                                <p:inputText id="txtDesctoComercial" value="#{mbPedidos.pedido.desctoComercial}" readonly="true" size="6" />
                            </p:column>
                            <p:column style="width: 190px; text-align: right;" >
                                <p:commandButton id="btnAgregarProducto" icon="ui-icon-search" value="Agregar" title="Agregar productos"
                                                 disabled="#{mbPedidos.pedido.pedidoEstatus!=0 or !mbPedidos.locked}"
                                                 process="@this" actionListener="#{mbPedidos.buscarProductos(':main:msgsPedido :main:detallePedido')}" 
                                                 update="buscarProductos listaBuscarProductos" oncomplete="PF('buscarProductoDlg').show();" />
                            </p:column>
                        </p:row>
                    </p:panelGrid>
                    <p:dataTable id="detallePedido" value="#{mbPedidos.detalle}"
                                 var="prod" rowKey="#{prod.producto}" selectionMode="single" 
                                 style="border:solid 1px; width: 910px;" emptyMessage="No existen productos" >
                        <p:ajax event="rowSelect" listener="#{mbPedidos.modificarProducto}"
                                update=":main:msgsPedido :main:panelEdicion" oncomplete="abrirEdicion(xhr, status, args);" />

                        <f:facet name="header" >Detalle del pedido</f:facet>
                        <p:column headerText="Codigo" style="width: 49px;" >
                            <h:outputText value="#{prod.producto.cod_pro}" />
                        </p:column>
                        <p:column headerText="Producto" >
                            <h:outputText value="#{prod.producto.toString()}" />
                        </p:column>
                        <p:column headerText="Cajas" style="width: 70px; text-align: right;" >
                            <h:outputText value="#{prod.ordenada}" >
                                <f:convertNumber pattern="###,##0.000" />
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Sin Cargo" style="width: 56px; text-align: right;" >
                            <h:outputText value="#{prod.ordenadaSinCargo}" >
                                <f:convertNumber pattern="###,##0.000" />
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Precio Lista" style="width: 70px; text-align: right;" >
                            <h:outputText value="#{prod.unitario*prod.producto.piezas}" >
                                <f:convertNumber pattern="###,##0.000000" />
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Importe" style="width: 70px; text-align: right;" >
                            <h:outputText value="#{prod.unitario*prod.cantFacturada}" >
                                <f:convertNumber pattern="###,##0.000000" />
                            </h:outputText>
                        </p:column>
                    </p:dataTable>
                    <p:panelGrid id="totales" styleClass="filaSinBorde colSinBorde" >
                        <p:row >
                            <p:column style="width: 600px;" ></p:column>
                            <p:column style="text-align: right; width: 110px;" >
                                <h:outputLabel for="txtSubTotal" value="SUBTOTAL :" style="font-weight: bold; color: black; width: 100px;" />
                            </p:column>
                            <p:column style="text-align: left; width: 160px;" >
                                <p:inputText id="txtSubTotal" value="#{mbPedidos.pedido.subTotal}" readonly="true" 
                                             style="text-align: right; font-size: 14px; width: 125px;" >
                                    <f:convertNumber pattern="##,###,##0.000000" />
                                </p:inputText>
                            </p:column>
                        </p:row>
                        <p:row rendered="#{mbPedidos.pedido.descuento!=0}" >
                            <p:column ></p:column>
                            <p:column style="text-align: right;" >
                                <h:outputLabel for="txtDescuento" value="DESCUENTO :" style="font-weight: bold; color: black; width: 100px;" />
                            </p:column>
                            <p:column style="text-align: left;" >
                                <p:inputText id="txtDescuento" value="#{mbPedidos.pedido.descuento}" readonly="true" 
                                             style="text-align: right; font-size: 14px; width: 125px;" >
                                    <f:convertNumber pattern="##,###,##0.000000" />
                                </p:inputText>
                            </p:column>
                        </p:row>
                        <p:row >
                            <p:column >
                                <p:outputLabel rendered="#{mbPedidos.pedido.especial}" value="** ESPECIAL **"
                                               style="font-weight: bold; color: red; font-size: medium; width: 150px;" />
                            </p:column>
                            <p:column colspan="2" >
                                <p:dataTable value="#{mbPedidos.impuestosTotales}" var="xx_imp" style="width: 280px;" >
                                    <p:column style="text-align: right; width: 98px;" >
                                        <h:outputText value="#{xx_imp.impuesto} :.." style="font-weight: bold; color: black; font-size: 14px; width: 90px;" />
                                    </p:column>
                                    <p:column style="width: 135px; text-align: left;" >
                                        <p:inputText value="#{xx_imp.importe}" readonly="true" style="text-align: right; font-size: 14px; width: 125px;" >
                                            <f:convertNumber pattern="##,###,##0.000000" />
                                        </p:inputText>
                                    </p:column>
                                </p:dataTable>
                            </p:column>
                        </p:row>
                        <p:row >
                            <p:column style="text-align: left;" >
                                <p:commandButton id="btnPedidoEliminar" icon="ui-icon-trash" value="ELIMINAR" title="Eliminar el pedido" 
                                                 disabled="#{mbPedidos.pedido.pedidoEstatus!=0 or !mbPedidos.locked}"
                                                 process="@this" actionListener="#{mbPedidos.eliminarPedido()}" 
                                                 update=":main:msgsPedido" oncomplete="handlePedido(xhr, status, args);" >
                                    <p:confirm header="Eliminar el pedido" message="Confirma ?" icon="ui-icon-alert" />
                                </p:commandButton>
                                <p:commandButton id="btnPedidoCerrar" value="CERRAR" title="Cerrar pedido, ya no se podra modificar" 
                                                 disabled="#{mbPedidos.pedido.pedidoEstatus!=0 or !mbPedidos.locked 
                                                             or (mbPedidos.pedido.especial and !mbPedidos.mbAcciones.validarAccion('btnPedidoCerrar'))}"
                                                 process="@this" actionListener="#{mbPedidos.cerrarPedido()}" 
                                                 update=":main:msgsPedido :main:pedido :main:totales" >
                                    <p:confirm header="Cerrar el pedido" message="Confirma ?" icon="ui-icon-alert" />
                                </p:commandButton>
                                <p:commandButton id="btnPedidoCancelar" icon="ui-icon-cancel" value="CANCELAR" title="Cancelar el pedido" 
                                                 disabled="#{mbPedidos.pedido.pedidoEstatus != 1 or !mbPedidos.locked}"
                                                 process="@this" update=":main:cancelarPedido" 
                                                 oncomplete="PF('cancelarPedidoDlg').show();" />
                            </p:column>
                            <p:column style="text-align: right;" >
                                <h:outputLabel for="txtTotales" value="TOTAL :" style="font-weight: bold; color: black; width: 100px;" />
                            </p:column>
                            <p:column style="text-align: left;" >
                                <p:inputText id="txtTotales" value="#{mbPedidos.pedido.total}" readonly="true" 
                                             style="text-align: right; font-size: 14px; width: 125px;" >
                                    <f:convertNumber pattern="##,###,##0.000000" />
                                </p:inputText>
                            </p:column>
                        </p:row>
                    </p:panelGrid>
                </p:dialog>
                <p:confirmDialog global="true" >
                    <p:commandButton value="Si" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                    <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                </p:confirmDialog>
                <p:dialog header="BUSCADOR DE PRODUCTOS" widgetVar="buscarProductoDlg" resizable="false" style="width: 600px;" modal="true" >
                    <p:messages id="msgBuscar" showDetail="true" autoUpdate="true" closable="true" />
                    <p:panelGrid id="buscarProductos" styleClass="sinBorde" >
                        <p:row >
                            <p:column >
                                <h:outputLabel for="opciones" value="OPCIONES :" style="font-weight: bold; color: red;" />
                            </p:column>
                            <p:column >
                                <p:selectOneRadio id="opciones" value="#{mbPedidos.mbBuscar.tipoBuscar}" style="background-color: #ccc" >
                                    <f:selectItem itemLabel="SKU" itemValue="1" />
                                    <f:selectItem itemLabel="Genérico" itemValue="2" />
                                    <f:selectItem itemLabel="Descripcion" itemValue="3" />
                                    <p:ajax listener="#{mbPedidos.mbBuscar.verCambio()}" 
                                            update="buscarProductos listaBuscarProductos" />
                                </p:selectOneRadio>
                            </p:column>
                            <p:column rendered="#{mbPedidos.mbBuscar.tipoBuscar=='1'}" >
                                <p:inputText id="opcionSKU" value="#{mbPedidos.mbBuscar.strBuscar}" maxlength="8" size="10" />
                                <p:commandButton id="btnBuscarSKU" icon="ui-icon-check" title="Buscar" 
                                                 process="@this opcionSKU" actionListener="#{mbPedidos.buscar()}" 
                                                 update=":main:msgBuscar #{mbPedidos.mbBuscar.update}" 
                                                 oncomplete="handleBuscar(xhr, status, args)" />
                            </p:column>
                            <p:column rendered="#{mbPedidos.mbBuscar.tipoBuscar=='2'}" >
                                <p:autoComplete id="opcionParte" value="#{mbPedidos.mbBuscar.mbParte.parte}" maxlength="24" size="24"
                                                completeMethod="#{mbPedidos.mbBuscar.mbParte.completePartes}" 
                                                var="p" itemLabel="#{p.parte}" itemValue="#{p}" converter="converters.Parte" 
                                                forceSelection="true" />
                                <p:commandButton id="btnBuscarLista" icon="ui-icon-check" title="Buscar" 
                                                 process="@this opcionParte" actionListener="#{mbPedidos.buscar()}" 
                                                 update="listaBuscarProductos"  />
                            </p:column>
                            <p:column rendered="#{mbPedidos.mbBuscar.tipoBuscar=='3'}" >
                                <p:inputText id="opcionDescripcion" value="#{mbPedidos.mbBuscar.strBuscar}" maxlength="24" size="24" />
                                <p:commandButton id="btnBuscarDescripcion" icon="ui-icon-check" title="Buscar" 
                                                 process="@this opcionDescripcion" actionListener="#{mbPedidos.buscar()}" 
                                                 update="listaBuscarProductos" />
                            </p:column>
                        </p:row>
                    </p:panelGrid>
                    <p:dataTable id="listaBuscarProductos" value="#{mbPedidos.mbBuscar.productos}" 
                                 var="prod" scrollable="true" scrollHeight="200" style="width: 800px;"
                                 rowKey="#{prod.idProducto}" selectionMode="single" selection="#{mbPedidos.mbBuscar.producto}" >
                        <p:ajax event = "rowSelect" update="seleccion" />

                        <f:facet name="header">Seleccione un producto</f:facet>

                        <p:column headerText="SKU" style="width: 250px;" >
                            <h:outputText value="#{prod.cod_pro}" />
                        </p:column>

                        <p:column headerText="Producto" style="width: 250px;" >
                            <h:outputText value="#{prod.toString()}" />
                        </p:column>

                        <f:facet name="footer">
                            <p:commandButton id="seleccion" value="Seleccionar" 
                                             disabled="#{mbPedidos.mbBuscar.producto==null}"
                                             process="@this" actionListener="#{mbPedidos.actualizaProductoSeleccionado()}"
                                             update=":main:msgBuscar #{mbPedidos.mbBuscar.update}" 
                                             oncomplete="handleBuscar(xhr, status, args);" />
                        </f:facet>
                    </p:dataTable>
                </p:dialog>
                <p:dialog widgetVar="nuevoPedidoDlg" closable="true" header="Crear un nuevo pedido" modal="true" resizable="false" >
                    <p:messages id="msgsNuevoPedido" autoUpdate="false" showDetail="true" closable="true" />
                    <p:panelGrid id="nuevoPedido" style="width: 870px;" >
                        <p:row rendered="false" >
                            <p:column style="width: 70px;" ></p:column>
                            <p:column style="width: 60px;" ></p:column>
                            <p:column style="width: 160px;" ></p:column>
                            <p:column style="width: 60px;" ></p:column>
                            <p:column style="width: 60px;" ></p:column>
                            <p:column style="width: 70px;" ></p:column>
                            <p:column ></p:column>
                        </p:row>
                        <p:row >
                            <p:column style="width: 70px;" >
                                <h:outputLabel for="cliente" value="CLIENTE :"
                                               style="font-weight: bold; color: black; width: 69px;" />
                            </p:column>
                            <p:column colspan="4" >
                                <p:selectOneMenu id="cliente" value="#{mbPedidos.mbClientes.cliente}"
                                                 filter="true" filterMatchMode="contains" style="width: 400px;" >
                                    <f:converter converterId="converters.miniCliente" />
                                    <f:selectItems value="#{mbPedidos.mbClientes.listaClientes}" />
                                    <p:ajax event="change" listener="#{mbPedidos.cambioDeCliente()}" 
                                            update=":main:msgsNuevoPedido listaTiendas btnCrearPedido" />
                                </p:selectOneMenu>
                            </p:column>
                            <p:column style="width: 70px;" >
                                <h:outputLabel for="cboMoneda" value="MONEDA :"
                                               style="font-weight: bold; color: black; width: 71px;" />
                            </p:column>
                            <p:column colspan="2" >
                                <p:selectOneMenu id="cboMoneda" value="#{mbPedidos.mbComprobantes.mbMonedas.seleccionMoneda}"
                                                 style="width: 200px;">
                                    <f:converter converterId="converters.Moneda" />
                                    <f:selectItems value="#{mbPedidos.mbComprobantes.mbMonedas.listaMonedas}" />
                                    <p:ajax event="change" process="@this" />
                                </p:selectOneMenu>
                            </p:column>
                        </p:row>
                        <p:row >
                            <p:column colspan="2" >
                                <h:outputLabel for="orden" value="ORDEN DE COMPRA :"
                                               style="font-weight: bold; color: black; width: 148px;" />
                            </p:column>
                            <p:column style="width: 160px;" >
                                <p:inputText id="orden" value="#{mbPedidos.pedido.ordenDeCompra}" maxlength="24" size="25" />
                            </p:column>
                            <p:column style="width: 60px;" >
                                <h:outputLabel for="ordenFecha" value="FECHA :"
                                               style="font-weight: bold; color: black; width: 57px;" />
                            </p:column>
                            <p:column colspan="2" >
                                <p:calendar id="ordenFecha" value="#{mbPedidos.pedido.ordenDeCompraFecha}"
                                            readonlyInput="true"
                                            locale="es" navigator="true" pattern="dd/MM/yyyy" >
                                    <p:ajax event="dateSelect" process="@this" />
                                </p:calendar>
                            </p:column>
                            <p:column colspan="2" >
                                <p:selectBooleanCheckbox id="chkEspeciales" itemLabel="Especial (Solo sin cargo)"
                                                         value="#{mbPedidos.pedido.especial}" style="width: 145px;" >
                                </p:selectBooleanCheckbox>
                            </p:column>
                        </p:row>
                        <p:row >
                            <p:column >
                                <h:outputLabel value="ENTREGA"
                                               style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column >
                                <h:outputLabel for="entregaFolio" value="FOLIO :"
                                               style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column style="width: 160px;" >
                                <p:inputText id="entregaFolio" value="#{mbPedidos.pedido.entregaFolio}" maxlength="20" size="20" />
                            </p:column>
                            <p:column >
                                <h:outputLabel for="entregaFecha" value="FECHA :"
                                               style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column colspan="2" >
                                <p:calendar id="entregaFecha" value="#{mbPedidos.pedido.entregaFecha}"
                                            readonlyInput="true"
                                            locale="es" navigator="true" pattern="dd/MM/yyyy" >
                                    <p:ajax event="dateSelect" process="@this" />
                                </p:calendar>
                            </p:column>
                            <p:column >
                                <h:outputLabel for="entregaCancelacion" value="CANC :"
                                               style="font-weight: bold; color: black;" />
                            </p:column>
                            <p:column >
                                <p:calendar id="entregaCancelacion" value="#{mbPedidos.pedido.entregaFechaMaxima}"
                                            readonlyInput="true"
                                            locale="es" navigator="true" pattern="dd/MM/yyyy" >
                                    <p:ajax event="dateSelect" process="@this" />
                                </p:calendar>
                            </p:column>
                        </p:row>
                        <p:row >
                            <p:column colspan="8" >
                                <p:dataTable id="listaTiendas" widgetVar="listaTiendasDlg" value="#{mbPedidos.mbTiendas.tiendas}" 
                                             var="tienda" rowKey="#{tienda.idTienda}" selectionMode="single" selection="#{mbPedidos.mbTiendas.tienda}"
                                             scrollable="true" scrollHeight="200"
                                             style="border:solid 1px; width: 910px;" emptyMessage="No existen tiendas" >
                                    <p:ajax event = "rowSelect" update=":main:btnCrearPedido" />

                                    <p:column headerText="CODIGO" style="width: 50px;" >
                                        <h:outputText value="#{tienda.codigoTienda}" />
                                    </p:column>
                                    <p:column headerText="TIENDA" style="width: 800px;" >
                                        <h:outputText value="#{tienda.toString()}" />
                                    </p:column>
                                </p:dataTable>
                            </p:column>
                        </p:row>
                        <f:facet name="footer" >
                            <p:row >
                                <p:column colspan="7" style="text-align: right;" >
                                    <p:commandButton id="btnCrearPedido" icon="ui-icon-document" value="Crear" title="Crear pedido" 
                                                     disabled="#{mbPedidos.mbTiendas.tienda.idTienda==0}"
                                                     process="nuevoPedido" 
                                                     actionListener="#{mbPedidos.crearPedido()}"
                                                     update=":main:msgsNuevoPedido :main:listaDePedidos :main:pedido :main:detallePedido :main:totales" 
                                                     oncomplete="nuevoPedido(xhr, status, args);" />
                                    <p:commandButton icon="ui-icon-arrowreturnthick-1-w" value="Cancelar" title="Cancelar" 
                                                     immediate="true" onclick="PF('nuevoPedidoDlg').hide();" />
                                </p:column>
                            </p:row>
                        </f:facet>
                    </p:panelGrid>
                </p:dialog>
            </h:form>
            <ui:include src="footer.xhtml" />
        </div>
        <script type="text/javascript" >
                function handleSimilares(xhr, status, args) {
                    if (!(args.validationFailed || !args.okSimilares)) {
                        PF('similaresDlg').hide();
                        PF('EdicionDlg').hide();
                    }
                }
                function handleAbrirSimilares(xhr, status, args) {
                    if (!(args.validationFailed || !args.okSimilares)) {
                        PF('similaresDlg').show();
                    }
                }
                function handleProductoEliminar(xhr, status, args) {
                    if (!(args.validationFailed || !args.okProductoEliminar)) {
                        PF('EdicionDlg').hide();
                    }
                }
                function handleEdicion(xhr, status, args) {
                    if (!(args.validationFailed || !args.okEdicion)) {
                        PF('EdicionDlg').hide();
                    }
                }
                function abrirEdicion(xhr, status, args) {
                    if (!(args.validationFailed || !args.okEdicion)) {
                        PF('EdicionDlg').show();
                    }
                }
                function handleBuscar(xhr, status, args) {
                    if (!(args.validationFailed || !args.okBuscar)) {
                        PF('buscarProductoDlg').hide();
                    }
                }
                function handleCancelarPedido(xhr, status, args) {
                    if (!(args.validationFailed || !args.okPedido)) {
                        PF('pedidoDlg').hide();
                    }
                }
                function handlePedido(xhr, status, args) {
                    if (!(args.validationFailed || !args.okPedido)) {
                        PF('pedidoDlg').hide();
                    }
                }
                function abrirPedido(xhr, status, args) {
                    if (!(args.validationFailed || !args.okPedido)) {
                        PF('pedidoDlg').show();
                    }
                }
                function nuevoPedido(xhr, status, args) {
                    if (!(args.validationFailed || !args.okPedido)) {
                        PF('nuevoPedidoDlg').hide();
                        PF('pedidoDlg').show();
                    }
                }
        </script>
    </body>
</html>
